apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: oauth2-proxy
  namespace: default
spec:
  hosts:
    - oauth2-proxy.local
  gateways:
    - app-gateway
  http:
    # 1) Drop malicious X-Forwarded-Uri
    - match:
        - headers:
            x-forwarded-uri:
              regex: "(?i)(interact\\.sploit|burpcollaborator|dnslog|[a-z][a-z0-9+.-]*://)"
      directResponse:
        status: 404
        body: { string: "Not Found" }

    # 2) Drop abusive rd= redirect params (block absolute URLs and suspicious domains)
    - match:
        - queryParams:
            rd:
              regex: "(?i)(?:^(?:[a-z][a-z0-9+.-]*://|//|[a-z][a-z0-9+.-]*%3a%2f%2f|%2f%2f)|interact\\.sploit|burpcollaborator|dnslog)"
      directResponse:
        status: 404
        body: { string: "Not Found" }

    - match:
        - uri:
            prefix: /oauth2/
      route:
        - destination:
            host: oauth2-proxy.default.svc.cluster.local
            port:
              number: 4180
